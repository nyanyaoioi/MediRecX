// åŒ»ç–—è®°å½•æ–‡æœ¬åŠ å¯†å·¥å…·
import { ethers } from "ethers";

/**
 * ä½¿ç”¨AESåŠ å¯†åŒ»ç–—è®°å½•æ–‡æœ¬è¯¦æƒ…
 */
export async function encryptMedicalDetails(
  details: string,
  patientAddress: string,
  doctorAddress: string
): Promise<{
  encryptedDetails: string;
  detailsHash: string;
}> {
  try {
    // åˆ›å»ºåŸºäºåœ°å€çš„åŠ å¯†å¯†é’¥ï¼ˆç¡®ä¿å¯†é’¥é•¿åº¦æ­£ç¡®ï¼‰
    const keyMaterial = `${patientAddress}-${doctorAddress}`;
    const encoder = new TextEncoder();
    const keyData = encoder.encode(keyMaterial);
    
    // ç”Ÿæˆå›ºå®šé•¿åº¦çš„32å­—èŠ‚å¯†é’¥
    const keyArray = new Uint8Array(32);
    for (let i = 0; i < keyArray.length; i++) {
      keyArray[i] = keyData[i % keyData.length];
    }
    
    // ç”ŸæˆåŠ å¯†å¯†é’¥
    const cryptoKey = await crypto.subtle.importKey(
      "raw",
      keyArray,
      { name: "AES-GCM" },
      false,
      ["encrypt"]
    );

    // ç”ŸæˆéšæœºIV
    const iv = crypto.getRandomValues(new Uint8Array(12));
    
    // åŠ å¯†åŒ»ç–—è¯¦æƒ…
    const detailsData = encoder.encode(details);
    const encryptedBuffer = await crypto.subtle.encrypt(
      { name: "AES-GCM", iv },
      cryptoKey,
      detailsData
    );

    // ç»„åˆIVå’ŒåŠ å¯†æ•°æ®
    const combined = new Uint8Array(iv.length + encryptedBuffer.byteLength);
    combined.set(iv);
    combined.set(new Uint8Array(encryptedBuffer), iv.length);
    
    // è½¬æ¢ä¸ºhexå­—ç¬¦ä¸²
    const encryptedDetails = "0x" + Array.from(combined)
      .map(b => b.toString(16).padStart(2, '0'))
      .join('');

    // è®¡ç®—è¯¦æƒ…å“ˆå¸Œ
    const detailsHash = ethers.keccak256(ethers.toUtf8Bytes(details));

    console.log(`[åŒ»ç–—è®°å½•åŠ å¯†] âœ… æ–‡æœ¬åŠ å¯†å®Œæˆ`);
    console.log(`  åŸæ–‡é•¿åº¦: ${details.length} å­—ç¬¦`);
    console.log(`  åŠ å¯†é•¿åº¦: ${encryptedDetails.length} å­—ç¬¦`);
    console.log(`  å“ˆå¸Œå€¼: ${detailsHash}`);

    return {
      encryptedDetails,
      detailsHash,
    };

  } catch (error) {
    console.error("[åŒ»ç–—è®°å½•åŠ å¯†] âŒ åŠ å¯†å¤±è´¥:", error);
    throw new Error("åŒ»ç–—è®°å½•æ–‡æœ¬åŠ å¯†å¤±è´¥");
  }
}

/**
 * è§£å¯†åŒ»ç–—è®°å½•æ–‡æœ¬è¯¦æƒ…
 */
export async function decryptMedicalDetails(
  encryptedDetails: string,
  expectedHash: string,
  patientAddress: string,
  doctorAddress: string
): Promise<string> {
  try {
    console.log(`[åŒ»ç–—è®°å½•è§£å¯†] ğŸ”“ å¼€å§‹è§£å¯†åŒ»ç–—æ–‡æœ¬...`);
    
    // ç§»é™¤0xå‰ç¼€å¹¶è½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
    const hexString = encryptedDetails.startsWith('0x') 
      ? encryptedDetails.slice(2) 
      : encryptedDetails;
    
    const combined = new Uint8Array(
      hexString.match(/.{1,2}/g)?.map(byte => parseInt(byte, 16)) || []
    );

    if (combined.length < 12) {
      throw new Error("åŠ å¯†æ•°æ®æ ¼å¼æ— æ•ˆ");
    }

    // åˆ†ç¦»IVå’ŒåŠ å¯†æ•°æ®
    const iv = combined.slice(0, 12);
    const encryptedBuffer = combined.slice(12);

    // åˆ›å»ºè§£å¯†å¯†é’¥ï¼ˆä¸åŠ å¯†æ—¶ç›¸åŒçš„æ–¹æ³•ï¼‰
    const keyMaterial = `${patientAddress}-${doctorAddress}`;
    const encoder = new TextEncoder();
    const keyData = encoder.encode(keyMaterial);
    
    // ç”Ÿæˆå›ºå®šé•¿åº¦çš„32å­—èŠ‚å¯†é’¥
    const keyArray = new Uint8Array(32);
    for (let i = 0; i < keyArray.length; i++) {
      keyArray[i] = keyData[i % keyData.length];
    }
    
    const cryptoKey = await crypto.subtle.importKey(
      "raw",
      keyArray,
      { name: "AES-GCM" },
      false,
      ["decrypt"]
    );

    // è§£å¯†æ•°æ®
    const decryptedBuffer = await crypto.subtle.decrypt(
      { name: "AES-GCM", iv },
      cryptoKey,
      encryptedBuffer
    );

    // è½¬æ¢ä¸ºæ–‡æœ¬
    const decoder = new TextDecoder();
    const decryptedText = decoder.decode(decryptedBuffer);

    // éªŒè¯å“ˆå¸Œå®Œæ•´æ€§
    const actualHash = ethers.keccak256(ethers.toUtf8Bytes(decryptedText));
    if (actualHash !== expectedHash) {
      console.warn("[åŒ»ç–—è®°å½•è§£å¯†] âš ï¸ å“ˆå¸ŒéªŒè¯å¤±è´¥ï¼Œæ•°æ®å¯èƒ½å·²è¢«ç¯¡æ”¹");
    }

    console.log(`[åŒ»ç–—è®°å½•è§£å¯†] âœ… æ–‡æœ¬è§£å¯†å®Œæˆ`);
    console.log(`  è§£å¯†é•¿åº¦: ${decryptedText.length} å­—ç¬¦`);
    console.log(`  å“ˆå¸ŒéªŒè¯: ${actualHash === expectedHash ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}`);

    return decryptedText;

  } catch (error) {
    console.error("[åŒ»ç–—è®°å½•è§£å¯†] âŒ è§£å¯†å¤±è´¥:", error);
    throw new Error("åŒ»ç–—è®°å½•æ–‡æœ¬è§£å¯†å¤±è´¥");
  }
}

/**
 * ç”Ÿæˆç¤ºä¾‹åŒ»ç–—è®°å½•æ–‡æœ¬
 */
export function generateSampleMedicalDetails(
  recordType: string,
  severity: number,
  patientName: string = "æ‚£è€…"
): string {
  const timestamp = new Date().toLocaleString();
  
  const templates = {
    "è¯Šæ–­": `ğŸ“‹ è¯Šæ–­è®°å½•

æ‚£è€…ä¿¡æ¯ï¼š${patientName}
è¯Šæ–­æ—¶é—´ï¼š${timestamp}
ä¸»è¦ç—‡çŠ¶ï¼š${severity > 7 ? 'ä¸¥é‡ç—‡çŠ¶ï¼Œéœ€è¦ç«‹å³å…³æ³¨' : severity > 4 ? 'ä¸­ç­‰ç—‡çŠ¶ï¼Œå»ºè®®è§‚å¯Ÿ' : 'è½»å¾®ç—‡çŠ¶ï¼Œå®šæœŸå¤æŸ¥'}

è¯Šæ–­ç»“æœï¼š
æ ¹æ®æ‚£è€…çš„ä¸´åºŠè¡¨ç°å’Œæ£€æŸ¥ç»“æœï¼Œåˆæ­¥è¯Šæ–­ä¸ºç›¸å…³ç–¾ç—…ã€‚æ‚£è€…ç›®å‰çŠ¶å†µ${severity > 7 ? 'éœ€è¦ç´§æ€¥å¤„ç†' : 'ç›¸å¯¹ç¨³å®š'}ã€‚

æ²»ç–—å»ºè®®ï¼š
1. ${severity > 7 ? 'ç«‹å³ä½é™¢æ²»ç–—' : 'é—¨è¯Šéšè®¿æ²»ç–—'}
2. å®šæœŸå¤æŸ¥ç›¸å…³æŒ‡æ ‡
3. æ³¨æ„ä¼‘æ¯å’Œé¥®é£Ÿè°ƒèŠ‚
4. å¦‚æœ‰å¼‚å¸¸åŠæ—¶å°±åŒ»

åŒ»ç”Ÿç­¾åï¼šDr.${new Date().getTime().toString().slice(-4)}
è®°å½•ç­‰çº§ï¼š${severity}/10`,

    "å¤„æ–¹": `ğŸ’Š å¤„æ–¹è®°å½•

æ‚£è€…ä¿¡æ¯ï¼š${patientName}
å¼€æ–¹æ—¶é—´ï¼š${timestamp}
ç—‡çŠ¶ä¸¥é‡ç¨‹åº¦ï¼š${severity}/10

å¤„æ–¹è¯ç‰©ï¼š
1. ${severity > 7 ? 'å¼ºæ•ˆæŠ—ç”Ÿç´ ' : severity > 4 ? 'å¸¸è§„æ¶ˆç‚è¯' : 'ç»´ç”Ÿç´ è¡¥å……å‰‚'} - æ¯æ—¥3æ¬¡ï¼Œé¥­åæœç”¨
2. æ­¢ç—›è¯ç‰© - ç–¼ç—›æ—¶æœç”¨ï¼Œæ¯æ—¥æœ€å¤š3æ¬¡
3. è¾…åŠ©è¯ç‰© - æ”¹å–„ç—‡çŠ¶ï¼Œæ¯æ—¥1æ¬¡

ç”¨è¯æ³¨æ„äº‹é¡¹ï¼š
- æŒ‰æ—¶æŒ‰é‡æœè¯ï¼Œä¸å¯æ“…è‡ªåœè¯
- å¦‚æœ‰è¿‡æ•ååº”ç«‹å³åœè¯å°±åŒ»
- æœè¯æœŸé—´é¿å…é¥®é…’
- å®šæœŸå¤æŸ¥è‚è‚¾åŠŸèƒ½

åŒ»ç”Ÿå˜±æ‰˜ï¼šä¸¥æ ¼æŒ‰ç…§å¤„æ–¹ç”¨è¯ï¼Œæœ‰é—®é¢˜åŠæ—¶è”ç³»ã€‚`,

    "æ£€æŸ¥ç»“æœ": `ğŸ”¬ æ£€æŸ¥ç»“æœæŠ¥å‘Š

æ‚£è€…ä¿¡æ¯ï¼š${patientName}
æ£€æŸ¥æ—¶é—´ï¼š${timestamp}
æ£€æŸ¥ç±»å‹ï¼š${severity > 7 ? 'ç´§æ€¥æ£€æŸ¥' : 'å¸¸è§„æ£€æŸ¥'}

æ£€æŸ¥ç»“æœï¼š
- è¡€å¸¸è§„ï¼š${severity > 7 ? 'å¼‚å¸¸ï¼Œéœ€è¦å…³æ³¨' : 'åŸºæœ¬æ­£å¸¸'}
- ç”ŸåŒ–æŒ‡æ ‡ï¼šå„é¡¹æŒ‡æ ‡${severity > 4 ? 'éƒ¨åˆ†å¼‚å¸¸' : 'æ­£å¸¸èŒƒå›´å†…'}
- å½±åƒå­¦æ£€æŸ¥ï¼š${severity > 7 ? 'å‘ç°å¼‚å¸¸ä¿¡å·' : 'æœªè§æ˜æ˜¾å¼‚å¸¸'}

ç»“æœåˆ†æï¼š
æ ¹æ®æ£€æŸ¥ç»“æœï¼Œæ‚£è€…ç›®å‰çŠ¶å†µä¸º${severity > 7 ? 'éœ€è¦å¯†åˆ‡ç›‘æŠ¤' : severity > 4 ? 'éœ€è¦æ³¨æ„è§‚å¯Ÿ' : 'åŸºæœ¬ç¨³å®š'}ã€‚
å»ºè®®${severity > 7 ? 'ç«‹å³åˆ¶å®šæ²»ç–—æ–¹æ¡ˆ' : 'å®šæœŸéšè®¿å¤æŸ¥'}ã€‚

æ£€æŸ¥åŒ»ç”Ÿï¼šDr.${new Date().getTime().toString().slice(-4)}
æŠ¥å‘Šæ—¥æœŸï¼š${timestamp}`,

    "æ²»ç–—": `âš•ï¸ æ²»ç–—è®°å½•

æ‚£è€…ä¿¡æ¯ï¼š${patientName}
æ²»ç–—æ—¶é—´ï¼š${timestamp}
æ²»ç–—æ–¹æ¡ˆï¼šæ ¹æ®æ‚£è€…ç—…æƒ…åˆ¶å®šçš„ä¸ªæ€§åŒ–æ²»ç–—æ–¹æ¡ˆ

æ²»ç–—è¿‡ç¨‹ï¼š
1. åˆæ­¥è¯„ä¼°ï¼šæ‚£è€…ç—‡çŠ¶ä¸¥é‡ç¨‹åº¦${severity}/10
2. æ²»ç–—æ–¹æ³•ï¼š${severity > 7 ? 'ç§¯ææ²»ç–—æ–¹æ¡ˆ' : severity > 4 ? 'æ ‡å‡†æ²»ç–—æ–¹æ¡ˆ' : 'ä¿å®ˆæ²»ç–—æ–¹æ¡ˆ'}
3. æ²»ç–—æ•ˆæœï¼š${severity > 7 ? 'éœ€è¦æŒç»­è§‚å¯Ÿ' : 'æ•ˆæœè‰¯å¥½'}

æ²»ç–—è¯¦æƒ…ï¼š
- è¯ç‰©æ²»ç–—ï¼šæ ¹æ®ç—…æƒ…è°ƒæ•´ç”¨è¯æ–¹æ¡ˆ
- ç‰©ç†æ²»ç–—ï¼šé…åˆç›¸åº”çš„ç‰©ç†åº·å¤è®­ç»ƒ
- ç”Ÿæ´»æŒ‡å¯¼ï¼šè°ƒæ•´ä½œæ¯å’Œé¥®é£Ÿä¹ æƒ¯
- å¿ƒç†æ”¯æŒï¼šæä¾›å¿…è¦çš„å¿ƒç†ç–å¯¼

åç»­è®¡åˆ’ï¼š
${severity > 7 ? 'æ¯æ—¥è§‚å¯Ÿï¼Œæ ¹æ®æƒ…å†µè°ƒæ•´æ²»ç–—' : 'æ¯å‘¨å¤æŸ¥ï¼Œè¯„ä¼°æ²»ç–—æ•ˆæœ'}

ä¸»æ²»åŒ»ç”Ÿï¼šDr.${new Date().getTime().toString().slice(-4)}`,

    "æ‰‹æœ¯": `ğŸ¥ æ‰‹æœ¯è®°å½•

æ‚£è€…ä¿¡æ¯ï¼š${patientName}
æ‰‹æœ¯æ—¶é—´ï¼š${timestamp}
æ‰‹æœ¯ç±»å‹ï¼š${severity > 7 ? 'ç´§æ€¥æ‰‹æœ¯' : 'æ‹©æœŸæ‰‹æœ¯'}

æ‰‹æœ¯å‰è¯„ä¼°ï¼š
- æ‚£è€…ä¸€èˆ¬çŠ¶å†µï¼š${severity > 7 ? 'å±é‡ï¼Œéœ€è¦ç´§æ€¥å¹²é¢„' : 'è‰¯å¥½'}
- æ‰‹æœ¯é€‚åº”ç—‡ï¼šç¬¦åˆæ‰‹æœ¯æŒ‡å¾
- é£é™©è¯„ä¼°ï¼š${severity > 7 ? 'é«˜é£é™©æ‰‹æœ¯' : 'ä½é£é™©æ‰‹æœ¯'}

æ‰‹æœ¯è¿‡ç¨‹ï¼š
- æ‰‹æœ¯å¼€å§‹ï¼š${timestamp}
- éº»é†‰æ–¹å¼ï¼šå…¨èº«éº»é†‰
- æ‰‹æœ¯æ­¥éª¤ï¼šæŒ‰ç…§æ ‡å‡†æµç¨‹è¿›è¡Œ
- æ‰‹æœ¯æ—¶é•¿ï¼š${severity > 7 ? 'è¾ƒé•¿æ—¶é—´' : 'å¸¸è§„æ—¶é—´'}
- æœ¯ä¸­æƒ…å†µï¼š${severity > 7 ? 'å¤æ‚ï¼Œå¤„ç†å›°éš¾' : 'é¡ºåˆ©ï¼Œæ— å¼‚å¸¸'}

æœ¯åæƒ…å†µï¼š
- æ‚£è€…ç”Ÿå‘½ä½“å¾å¹³ç¨³
- ä¼¤å£æƒ…å†µè‰¯å¥½
- é¢„åè¯„ä¼°ï¼š${severity > 7 ? 'éœ€è¦å¯†åˆ‡è§‚å¯Ÿ' : 'é¢„åè‰¯å¥½'}

ä¸»åˆ€åŒ»ç”Ÿï¼šDr.${new Date().getTime().toString().slice(-4)}
æ‰‹æœ¯ç­‰çº§ï¼š${severity}/10`
  };

  return templates[recordType as keyof typeof templates] || templates["è¯Šæ–­"];
}

/**
 * åŸºäºFHEVMè§£å¯†æ•°æ®ç”Ÿæˆå®Œæ•´åŒ»ç–—è¯¦æƒ…
 */
export function generateCompleteMedicalDetails(
  recordType: string,
  severity: number,
  timestamp: number,
  isActive: boolean,
  doctorAddress: string
): string {
  const recordTime = new Date(timestamp * 1000).toLocaleString();
  const doctorId = doctorAddress.slice(-4);
  
  const severityLevel = severity > 7 ? 'ä¸¥é‡' : severity > 4 ? 'ä¸­ç­‰' : 'è½»å¾®';
  const urgency = severity > 7 ? 'éœ€è¦ç«‹å³å¤„ç†' : severity > 4 ? 'å»ºè®®å¯†åˆ‡è§‚å¯Ÿ' : 'å®šæœŸå¤æŸ¥å³å¯';
  
  const detailTemplates = {
    "è¯Šæ–­": `ğŸ“‹ è¯¦ç»†è¯Šæ–­æŠ¥å‘Š

ğŸ¥ è¯Šæ–­ä¿¡æ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… è¯Šæ–­æ—¶é—´ï¼š${recordTime}
ğŸ‘¨â€âš•ï¸ ä¸»è¯ŠåŒ»å¸ˆï¼šDr.${doctorId}
âš•ï¸ ä¸¥é‡ç­‰çº§ï¼š${severity}/10 (${severityLevel})
ğŸ” è®°å½•çŠ¶æ€ï¼š${isActive ? 'âœ… æœ‰æ•ˆè®°å½•' : 'âŒ å·²å½’æ¡£'}

ğŸ©º ä¸´åºŠè¡¨ç°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä¸»è¦ç—‡çŠ¶ï¼š${severity > 7 ? 'æ‚£è€…å‡ºç°ä¸¥é‡ç—‡çŠ¶ï¼ŒåŒ…æ‹¬æŒç»­æ€§ç–¼ç—›ã€åŠŸèƒ½éšœç¢ç­‰' : 
           severity > 4 ? 'æ‚£è€…æœ‰æ˜æ˜¾ä¸é€‚ç—‡çŠ¶ï¼Œæ—¥å¸¸æ´»åŠ¨å—åˆ°ä¸€å®šå½±å“' : 
           'æ‚£è€…ç—‡çŠ¶è¾ƒè½»ï¼ŒåŸºæœ¬ä¸å½±å“æ­£å¸¸ç”Ÿæ´»'}

ä½“å¾æ£€æŸ¥ï¼š
- ä¸€èˆ¬çŠ¶å†µï¼š${severity > 7 ? 'è¾ƒå·®ï¼Œç²¾ç¥èé¡' : severity > 4 ? 'ä¸€èˆ¬ï¼Œè½»åº¦ä¸é€‚' : 'è‰¯å¥½ï¼Œç²¾ç¥é¥±æ»¡'}
- ç”Ÿå‘½ä½“å¾ï¼šè¡€å‹ã€å¿ƒç‡ã€ä½“æ¸©ç­‰${severity > 7 ? 'å¼‚å¸¸' : 'åŸºæœ¬æ­£å¸¸'}
- ä¸“ç§‘æ£€æŸ¥ï¼š${severity > 7 ? 'å‘ç°æ˜æ˜¾å¼‚å¸¸ä½“å¾' : 'è½»å¾®å¼‚å¸¸æˆ–æ­£å¸¸'}

ğŸ”¬ è¯Šæ–­ç»“è®º
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åˆæ­¥è¯Šæ–­ï¼šåŸºäºä¸´åºŠç—‡çŠ¶å’Œæ£€æŸ¥ç»“æœçš„ç»¼åˆåˆ¤æ–­
è¯Šæ–­ä¾æ®ï¼šä¸´åºŠè¡¨ç° + è¾…åŠ©æ£€æŸ¥ + åŒ»å¸ˆç»éªŒ
å¯ä¿¡åº¦è¯„ä¼°ï¼š${severity > 7 ? 'é«˜åº¦å¯ä¿¡ï¼Œå»ºè®®ç«‹å³æ²»ç–—' : severity > 4 ? 'è¾ƒä¸ºå¯ä¿¡ï¼Œå»ºè®®è¿›ä¸€æ­¥ç¡®è®¤' : 'åˆæ­¥åˆ¤æ–­ï¼Œå»ºè®®è§‚å¯Ÿ'}

ğŸ’Š æ²»ç–—å»ºè®®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ²»ç–—æ–¹æ¡ˆï¼š${severity > 7 ? 'ç§¯ææ²»ç–—ï¼Œå¿…è¦æ—¶ä½é™¢' : severity > 4 ? 'è¯ç‰©æ²»ç–—é…åˆç‰©ç†ç–—æ³•' : 'ä¿å®ˆæ²»ç–—ï¼Œå®šæœŸéšè®¿'}
ç”¨è¯æŒ‡å¯¼ï¼šæ ¹æ®æ‚£è€…å…·ä½“æƒ…å†µåˆ¶å®šä¸ªæ€§åŒ–ç”¨è¯æ–¹æ¡ˆ
ç”Ÿæ´»å»ºè®®ï¼š${urgency}ï¼Œæ³¨æ„ä¼‘æ¯ï¼Œåˆç†é¥®é£Ÿï¼Œé€‚åº¦è¿åŠ¨

ğŸ“‹ éšè®¿è®¡åˆ’
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å¤æŸ¥æ—¶é—´ï¼š${severity > 7 ? '1å‘¨å†…' : severity > 4 ? '2-4å‘¨' : '1-3ä¸ªæœˆ'}
å¤æŸ¥é¡¹ç›®ï¼šç›¸å…³æ£€æŸ¥æŒ‡æ ‡å’Œç—‡çŠ¶è¯„ä¼°
è”ç³»æ–¹å¼ï¼šå¦‚æœ‰ç´§æ€¥æƒ…å†µè¯·åŠæ—¶å°±åŒ»

ğŸ” éšç§å£°æ˜ï¼šæœ¬è®°å½•é€šè¿‡FHEVMå®Œå…¨åŒæ€åŠ å¯†æŠ€æœ¯ä¿æŠ¤ï¼Œç¡®ä¿æ‚£è€…åŒ»ç–—éšç§å®‰å…¨ã€‚`,

    "å¤„æ–¹": `ğŸ’Š è¯¦ç»†å¤„æ–¹è®°å½•

ğŸ¥ å¤„æ–¹ä¿¡æ¯  
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… å¼€æ–¹æ—¶é—´ï¼š${recordTime}
ğŸ‘¨â€âš•ï¸ å¼€æ–¹åŒ»å¸ˆï¼šDr.${doctorId}
âš•ï¸ ç—…æƒ…ä¸¥é‡åº¦ï¼š${severity}/10 (${severityLevel})
ğŸ” å¤„æ–¹çŠ¶æ€ï¼š${isActive ? 'âœ… æœ‰æ•ˆå¤„æ–¹' : 'âŒ å·²å¤±æ•ˆ'}

ğŸ’Š å¤„æ–¹è¯ç‰©æ¸…å•
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä¸»è¦è¯ç‰©ï¼š
${severity > 7 ? 
`1. å¼ºæ•ˆæŠ—ç”Ÿç´ ç‰‡ 500mg - æ¯æ—¥3æ¬¡ï¼Œé¥­åæœç”¨ï¼Œè¿ç»­7å¤©
2. å¼ºæ•ˆæ­¢ç—›è¯ 100mg - ç–¼ç—›æ—¶æœç”¨ï¼Œæ¯æ—¥æœ€å¤š4æ¬¡  
3. å…ç–«è°ƒèŠ‚å‰‚ 25mg - æ¯æ—¥1æ¬¡ï¼Œç¡å‰æœç”¨` :
severity > 4 ?
`1. å¸¸è§„æŠ—ç‚è¯ 250mg - æ¯æ—¥2æ¬¡ï¼Œé¥­åæœç”¨ï¼Œè¿ç»­5å¤©
2. æ­¢ç—›è¯ 50mg - éœ€è¦æ—¶æœç”¨ï¼Œæ¯æ—¥æœ€å¤š3æ¬¡
3. ç»´ç”Ÿç´ è¡¥å……å‰‚ - æ¯æ—¥1æ¬¡ï¼Œéšé¤æœç”¨` :
`1. æ¸©å’Œè°ƒç†è¯ 100mg - æ¯æ—¥1æ¬¡ï¼Œé¥­åæœç”¨  
2. ç»´ç”Ÿç´ å¤åˆç‰‡ - æ¯æ—¥1æ¬¡ï¼Œæ—©é¤åæœç”¨
3. ç›Šç”ŸèŒèƒ¶å›Š - æ¯æ—¥1æ¬¡ï¼Œç¡å‰æœç”¨`}

ğŸ“‹ ç”¨è¯æŒ‡å¯¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æœè¯æ—¶é—´ï¼šä¸¥æ ¼æŒ‰ç…§ä¸Šè¿°æ—¶é—´å®‰æ’æœè¯
æ³¨æ„äº‹é¡¹ï¼š
- ${severity > 7 ? 'å¯†åˆ‡è§‚å¯Ÿè¯ç‰©ååº”ï¼Œå¦‚æœ‰ä¸é€‚ç«‹å³åœè¯' : 'æŒ‰æ—¶æœè¯ï¼Œä¸å¯æ“…è‡ªåœè¯æˆ–æ”¹å˜å‰‚é‡'}
- æœè¯æœŸé—´é¿å…é¥®é…’ï¼Œæ³¨æ„é¥®é£Ÿæ¸…æ·¡
- å¦‚å‡ºç°è¿‡æ•ç—‡çŠ¶ï¼ˆçš®ç–¹ã€å‘¼å¸å›°éš¾ç­‰ï¼‰ç«‹å³å°±åŒ»
- å®šæœŸå¤æŸ¥ç›¸å…³æŒ‡æ ‡ï¼Œè¯„ä¼°è¯ç‰©æ•ˆæœ

âš ï¸ ç¦å¿Œç—‡ï¼šå­•å¦‡ã€å“ºä¹³æœŸå¦‡å¥³ã€å¯¹è¯ç‰©è¿‡æ•è€…ç¦ç”¨
ğŸ”„ å¤æŸ¥è¦æ±‚ï¼š${severity > 7 ? '3-5å¤©åå¤æŸ¥' : severity > 4 ? '1-2å‘¨åå¤æŸ¥' : '1ä¸ªæœˆåå¤æŸ¥'}

ğŸ” å¤„æ–¹ç¼–å·ï¼šRX-${timestamp}-${doctorId}`,

    "æ£€æŸ¥ç»“æœ": `ğŸ”¬ è¯¦ç»†æ£€æŸ¥æŠ¥å‘Š

ğŸ¥ æ£€æŸ¥ä¿¡æ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… æ£€æŸ¥æ—¶é—´ï¼š${recordTime}
ğŸ‘¨â€âš•ï¸ æ£€æŸ¥åŒ»å¸ˆï¼šDr.${doctorId}
ğŸ” æ£€æŸ¥ç±»å‹ï¼š${severity > 7 ? 'ç´§æ€¥å…¨é¢æ£€æŸ¥' : severity > 4 ? 'å¸¸è§„ä¸“é¡¹æ£€æŸ¥' : 'ä½“æ£€ç­›æŸ¥'}
ğŸ” æŠ¥å‘ŠçŠ¶æ€ï¼š${isActive ? 'âœ… æ­£å¼æŠ¥å‘Š' : 'âŒ å·²å½’æ¡£'}

ğŸ“Š æ£€æŸ¥ç»“æœæ•°æ®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è¡€æ¶²æ£€æŸ¥ï¼š
- ç™½ç»†èƒè®¡æ•°ï¼š${severity > 7 ? 'å¼‚å¸¸å‡é«˜' : severity > 4 ? 'è½»åº¦å‡é«˜' : 'æ­£å¸¸èŒƒå›´'}
- çº¢ç»†èƒè®¡æ•°ï¼š${severity > 7 ? 'åä½' : 'æ­£å¸¸'}
- è¡€å°æ¿ï¼š${severity > 7 ? 'å¼‚å¸¸' : 'æ­£å¸¸'}
- ç”ŸåŒ–æŒ‡æ ‡ï¼šè‚åŠŸèƒ½ã€è‚¾åŠŸèƒ½ç­‰${severity > 7 ? 'å¤šé¡¹å¼‚å¸¸' : severity > 4 ? 'ä¸ªåˆ«å¼‚å¸¸' : 'åŸºæœ¬æ­£å¸¸'}

å½±åƒæ£€æŸ¥ï¼š
- Xå…‰/CTï¼š${severity > 7 ? 'å‘ç°æ˜æ˜¾ç—…å˜' : severity > 4 ? 'è½»å¾®å¼‚å¸¸å½±åƒ' : 'æœªè§æ˜æ˜¾å¼‚å¸¸'}
- è¶…å£°æ£€æŸ¥ï¼š${severity > 7 ? 'å¤šå¤„å¼‚å¸¸å›å£°' : severity > 4 ? 'å±€éƒ¨å¼‚å¸¸' : 'æ­£å¸¸'}

ğŸ”¬ ç»“æœåˆ†æ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ä¸´åºŠæ„ä¹‰ï¼š
æ£€æŸ¥ç»“æœæ˜¾ç¤ºæ‚£è€…ç›®å‰${severity > 7 ? 'ç—…æƒ…è¾ƒé‡ï¼Œéœ€è¦ç§¯æå¹²é¢„æ²»ç–—' : 
                     severity > 4 ? 'æœ‰ä¸€å®šç¨‹åº¦çš„å¼‚å¸¸ï¼Œå»ºè®®æ²»ç–—' : 
                     'çŠ¶å†µè‰¯å¥½ï¼Œç»§ç»­ä¿æŒå¥åº·ç”Ÿæ´»æ–¹å¼'}

å¼‚å¸¸æŒ‡æ ‡ï¼š${severity > 7 ? 'å¤šé¡¹æŒ‡æ ‡å¼‚å¸¸ï¼Œæç¤ºç–¾ç—…è¿›å±•' : severity > 4 ? 'å°‘æ•°æŒ‡æ ‡å¼‚å¸¸ï¼Œéœ€è¦å…³æ³¨' : 'å„é¡¹æŒ‡æ ‡åŸºæœ¬æ­£å¸¸'}

ğŸ“‹ åŒ»å¸ˆå»ºè®®
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
åç»­å¤„ç†ï¼š${urgency}
å¤æŸ¥è®¡åˆ’ï¼š${severity > 7 ? '1å‘¨å†…å¤æŸ¥ç›¸å…³æŒ‡æ ‡' : severity > 4 ? '2-4å‘¨å¤æŸ¥' : '3-6ä¸ªæœˆå¸¸è§„å¤æŸ¥'}
ç”Ÿæ´»æŒ‡å¯¼ï¼šæ ¹æ®æ£€æŸ¥ç»“æœè°ƒæ•´ç”Ÿæ´»æ–¹å¼å’Œæ²»ç–—æ–¹æ¡ˆ

ğŸ” æŠ¥å‘Šç¼–å·ï¼šRPT-${timestamp}-${doctorId}`,

    "æ²»ç–—": `âš•ï¸ è¯¦ç»†æ²»ç–—è®°å½•

ğŸ¥ æ²»ç–—ä¿¡æ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… æ²»ç–—æ—¶é—´ï¼š${recordTime}
ğŸ‘¨â€âš•ï¸ ä¸»æ²»åŒ»å¸ˆï¼šDr.${doctorId}
ğŸ¥ æ²»ç–—æ–¹å¼ï¼š${severity > 7 ? 'ä½é™¢ç»¼åˆæ²»ç–—' : severity > 4 ? 'é—¨è¯Šä¸“ç§‘æ²»ç–—' : 'é—¨è¯Šä¿å®ˆæ²»ç–—'}
âš•ï¸ æ²»ç–—ç­‰çº§ï¼š${severityLevel} (${severity}/10)
ğŸ” è®°å½•çŠ¶æ€ï¼š${isActive ? 'âœ… è¿›è¡Œä¸­' : 'âŒ å·²å®Œæˆ'}

ğŸ’Š æ²»ç–—æ–¹æ¡ˆè¯¦æƒ…
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
è¯ç‰©æ²»ç–—ï¼š
${severity > 7 ? 
`- ä¸»è¦è¯ç‰©ï¼šå¼ºæ•ˆæ²»ç–—è¯ç‰©ï¼Œé™è„‰ç»™è¯
- è¾…åŠ©è¯ç‰©ï¼šå¯¹ç—‡æ”¯æŒæ²»ç–—
- ç›‘æŠ¤è¦æ±‚ï¼šå¯†åˆ‡ç›‘æµ‹ç”Ÿå‘½ä½“å¾` :
severity > 4 ? 
`- ä¸»è¦è¯ç‰©ï¼šæ ‡å‡†æ²»ç–—è¯ç‰©ï¼Œå£æœä¸ºä¸»
- è¾…åŠ©æ²»ç–—ï¼šç‰©ç†æ²»ç–—é…åˆ
- è§‚å¯Ÿè¦æ±‚ï¼šå®šæœŸè¯„ä¼°æ²»ç–—æ•ˆæœ` :
`- ä¿å®ˆè¯ç‰©ï¼šæ¸©å’Œè°ƒç†è¯ç‰©
- ç”Ÿæ´»è°ƒèŠ‚ï¼šä½œæ¯å’Œé¥®é£ŸæŒ‡å¯¼
- éšè®¿è¦æ±‚ï¼šå®šæœŸé—¨è¯Šéšè®¿`}

ç‰©ç†æ²»ç–—ï¼š
${severity > 7 ? 'å§åºŠä¼‘æ¯ï¼Œå¿…è¦çš„æŠ¤ç†æªæ–½' : 
  severity > 4 ? 'é€‚åº¦æ´»åŠ¨ï¼Œä¸“ä¸šç‰©ç†åº·å¤' : 
  'æ­£å¸¸æ´»åŠ¨ï¼Œé€‚åº¦é”»ç‚¼'}

ğŸ¥ æ²»ç–—è¿‡ç¨‹è®°å½•
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ²»ç–—å¼€å§‹ï¼š${recordTime}
åˆå§‹è¯„ä¼°ï¼šæ‚£è€…ç—‡çŠ¶ä¸¥é‡ç¨‹åº¦${severity}/10ï¼Œ${urgency}
æ²»ç–—å“åº”ï¼š${severity > 7 ? 'å¯†åˆ‡è§‚å¯Ÿä¸­ï¼Œæ•ˆæœå¾…è¯„ä¼°' : severity > 4 ? 'æ²»ç–—å“åº”è‰¯å¥½' : 'ç—‡çŠ¶æ˜æ˜¾æ”¹å–„'}

ğŸ“Š ç–—æ•ˆè¯„ä¼°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å®¢è§‚æŒ‡æ ‡ï¼š${severity > 7 ? 'å…³é”®æŒ‡æ ‡æ”¹å–„æœ‰é™' : severity > 4 ? 'éƒ¨åˆ†æŒ‡æ ‡å¥½è½¬' : 'å„é¡¹æŒ‡æ ‡æ˜æ˜¾æ”¹å–„'}
ä¸»è§‚æ„Ÿå—ï¼š${severity > 7 ? 'æ‚£è€…ä»æœ‰æ˜æ˜¾ä¸é€‚' : severity > 4 ? 'æ‚£è€…è‡ªè§‰ç—‡çŠ¶å‡è½»' : 'æ‚£è€…æ„Ÿè§‰è‰¯å¥½'}
ç”Ÿæ´»è´¨é‡ï¼š${severity > 7 ? 'ä¸¥é‡å½±å“æ—¥å¸¸ç”Ÿæ´»' : severity > 4 ? 'è½»åº¦å½±å“ç”Ÿæ´»è´¨é‡' : 'åŸºæœ¬ä¸å½±å“æ­£å¸¸ç”Ÿæ´»'}

ğŸ“‹ åç»­è®¡åˆ’
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ç»§ç»­æ²»ç–—ï¼š${severity > 7 ? 'è°ƒæ•´æ²»ç–—æ–¹æ¡ˆï¼ŒåŠ å¼ºç›‘æŠ¤' : severity > 4 ? 'ç»´æŒå½“å‰æ²»ç–—æ–¹æ¡ˆ' : 'é€æ­¥å‡è¯è§‚å¯Ÿ'}
å¤æŸ¥å®‰æ’ï¼š${severity > 7 ? 'æ¯3-5å¤©å¤æŸ¥' : severity > 4 ? 'æ¯1-2å‘¨å¤æŸ¥' : 'æ¯æœˆå¤æŸ¥'}
åº·å¤æŒ‡å¯¼ï¼š${severity > 7 ? 'é™¢å†…åº·å¤è®­ç»ƒ' : severity > 4 ? 'é—¨è¯Šåº·å¤æŒ‡å¯¼' : 'å±…å®¶è‡ªæˆ‘åº·å¤'}

ğŸ” æ²»ç–—è®°å½•IDï¼šTRT-${timestamp}-${doctorId}`,

    "æ‰‹æœ¯": `ğŸ¥ è¯¦ç»†æ‰‹æœ¯è®°å½•

ğŸ¥ æ‰‹æœ¯åŸºæœ¬ä¿¡æ¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“… æ‰‹æœ¯æ—¶é—´ï¼š${recordTime}
ğŸ‘¨â€âš•ï¸ ä¸»åˆ€åŒ»å¸ˆï¼šDr.${doctorId}
ğŸ¥ æ‰‹æœ¯ç±»å‹ï¼š${severity > 7 ? 'æ€¥è¯Šé‡å¤§æ‰‹æœ¯' : severity > 4 ? 'æ‹©æœŸä¸­ç­‰æ‰‹æœ¯' : 'é—¨è¯Šå°æ‰‹æœ¯'}
âš•ï¸ æ‰‹æœ¯ç­‰çº§ï¼š${severityLevel} (${severity}/10)
ğŸ” è®°å½•çŠ¶æ€ï¼š${isActive ? 'âœ… æœ¯åæ¢å¤ä¸­' : 'âŒ å·²åº·å¤å‡ºé™¢'}

ğŸ”§ æ‰‹æœ¯è¯¦ç»†è¿‡ç¨‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æœ¯å‰å‡†å¤‡ï¼š
- æ‚£è€…è¯„ä¼°ï¼šä¸€èˆ¬çŠ¶å†µ${severity > 7 ? 'è¾ƒå·®ï¼Œé«˜é£é™©' : severity > 4 ? 'è‰¯å¥½ï¼Œä¸­ç­‰é£é™©' : 'è‰¯å¥½ï¼Œä½é£é™©'}
- éº»é†‰æ–¹å¼ï¼š${severity > 7 ? 'å…¨èº«éº»é†‰+ç›‘æŠ¤' : severity > 4 ? 'å±€éƒ¨éº»é†‰æˆ–å…¨éº»' : 'å±€éƒ¨éº»é†‰'}
- æ‰‹æœ¯å›¢é˜Ÿï¼š${severity > 7 ? 'å¤šå­¦ç§‘åä½œ' : 'ä¸“ç§‘åŒ»å¸ˆ'}

æ‰‹æœ¯ç»è¿‡ï¼š
- æ‰‹æœ¯å¼€å§‹ï¼šæŒ‰è®¡åˆ’é¡ºåˆ©å¼€å§‹
- æ“ä½œè¿‡ç¨‹ï¼š${severity > 7 ? 'æ‰‹æœ¯å¤æ‚ï¼Œè€—æ—¶è¾ƒé•¿ï¼Œå¤„ç†å›°éš¾' : 
            severity > 4 ? 'æ‰‹æœ¯é¡ºåˆ©ï¼ŒæŒ‰è®¡åˆ’è¿›è¡Œ' : 
            'æ‰‹æœ¯ç®€å•ï¼Œå¿«é€Ÿå®Œæˆ'}
- æœ¯ä¸­å‘ç°ï¼š${severity > 7 ? 'ç—…å˜èŒƒå›´è¾ƒå¹¿ï¼Œæƒ…å†µå¤æ‚' : severity > 4 ? 'ç—…å˜å±€é™ï¼Œå¤„ç†é¡ºåˆ©' : 'ç—…å˜è½»å¾®ï¼Œæ˜“äºå¤„ç†'}
- æ‰‹æœ¯ç»“æŸï¼šé¡ºåˆ©å®Œæˆï¼Œæ‚£è€…ç”Ÿå‘½ä½“å¾å¹³ç¨³

ğŸ¥ æœ¯åæƒ…å†µ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
å³æ—¶çŠ¶å†µï¼š
- ç”Ÿå‘½ä½“å¾ï¼š${severity > 7 ? 'éœ€è¦å¯†åˆ‡ç›‘æŠ¤' : severity > 4 ? 'åŸºæœ¬å¹³ç¨³' : 'å®Œå…¨ç¨³å®š'}
- ä¼¤å£æƒ…å†µï¼š${severity > 7 ? 'éœ€è¦ç‰¹æ®ŠæŠ¤ç†' : 'æ„ˆåˆè‰¯å¥½'}
- ç–¼ç—›è¯„ä¼°ï¼š${severity > 7 ? 'ä¸­é‡åº¦ç–¼ç—›ï¼Œéœ€è¦æ­¢ç—›' : severity > 4 ? 'è½»ä¸­åº¦ç–¼ç—›' : 'è½»å¾®ç–¼ç—›'}

åº·å¤è®¡åˆ’ï¼š
- å§åºŠæ—¶é—´ï¼š${severity > 7 ? '3-7å¤©ç»å¯¹å§åºŠ' : severity > 4 ? '1-3å¤©ç›¸å¯¹å§åºŠ' : 'å½“æ—¥å¯é€‚åº¦æ´»åŠ¨'}
- é¥®é£Ÿå®‰æ’ï¼š${severity > 7 ? 'æµè´¨é¥®é£Ÿï¼Œé€æ­¥è¿‡æ¸¡' : severity > 4 ? 'åŠæµè´¨é¥®é£Ÿ' : 'æ­£å¸¸é¥®é£Ÿ'}
- æ´»åŠ¨æŒ‡å¯¼ï¼š${severity > 7 ? 'ä¸¥æ ¼é™åˆ¶æ´»åŠ¨' : severity > 4 ? 'é€æ­¥å¢åŠ æ´»åŠ¨' : 'æ­£å¸¸æ´»åŠ¨'}

ğŸ“‹ å‡ºé™¢æŒ‡å¯¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
é¢„æœŸä½é™¢ï¼š${severity > 7 ? '7-14å¤©' : severity > 4 ? '3-7å¤©' : 'å½“æ—¥æˆ–æ¬¡æ—¥'}
å±…å®¶æŠ¤ç†ï¼šä¼¤å£æ¢è¯ã€ç”¨è¯æŒ‡å¯¼ã€æ´»åŠ¨é™åˆ¶
å¤æŸ¥å®‰æ’ï¼š${severity > 7 ? '1å‘¨å†…å¤æŸ¥' : severity > 4 ? '2å‘¨åå¤æŸ¥' : '1ä¸ªæœˆåå¤æŸ¥'}

ğŸ” æ‰‹æœ¯è®°å½•å·ï¼šSUR-${timestamp}-${doctorId}`
  };

  return detailTemplates[recordType as keyof typeof detailTemplates] || 
         detailTemplates["è¯Šæ–­"].replace("è¯Šæ–­", recordType);
}
